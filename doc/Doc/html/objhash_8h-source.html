<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>objhash.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<h1>objhash.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">    Prota language runtime</span>
00003 <span class="comment"></span>
00004 <span class="comment">    Object hash table</span>
00005 <span class="comment"></span>
00006 <span class="comment">    Copyright 2003 Walter R. Smith</span>
00007 <span class="comment">    Licensed under the MIT License. See LICENSE file in project root.</span>
00008 <span class="comment">*/</span>
00009 
00010 <span class="preprocessor">#ifndef __OBJHASH_H__</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define __OBJHASH_H__</span>
00012 <span class="preprocessor"></span>
00013 <span class="preprocessor">#include "gc.h"</span>
00014 
00015 <span class="comment">// Hash table with Value keys (uses Value itself as the key--pointer identity).</span>
00016 <span class="comment">// ObjHashTable&lt;type&gt; maps Value to type</span>
00017 
00018 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> VALUE_T&gt;
00019 <span class="keyword">class </span>ObjHashTable {
00020 <span class="keyword">public</span>:
00021     ObjHashTable()
00022     {
00023         m_size = 0;
00024         SetCapacity(32);
00025     }
00026 
00027     <span class="keywordtype">bool</span>    Get(Value key, <span class="comment">/*out*/</span> VALUE_T* pValue)
00028     {
00029         <span class="keywordtype">int</span> iSlot;
00030         <span class="keywordflow">if</span> (Find(key, &amp;iSlot)) {
00031             *pValue = m_table[iSlot].value;
00032             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00033         }
00034         <span class="keywordflow">else</span> {
00035             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00036         }
00037     }
00038 
00039     <span class="keywordtype">void</span>    Set(Value key, <span class="keyword">const</span> VALUE_T&amp; value)
00040     {
00041         <span class="keywordtype">int</span> iSlot;
00042         <span class="keywordflow">if</span> (Find(key, &amp;iSlot)) {
00043             m_table[iSlot].value = value;
00044         }
00045         <span class="keywordflow">else</span> {
00046             <span class="keywordflow">if</span> (m_size &gt;= m_capacity / 2 + m_capacity / 4)
00047                 Resize(m_capacity * 2);
00048 
00049             m_table[iSlot].key = key;
00050             m_table[iSlot].value = value;
00051         }
00052     }
00053 
00054     <span class="keywordtype">bool</span>    HasKey(Value key)
00055     {
00056         <span class="keywordtype">int</span> iSlot;
00057         <span class="keywordflow">return</span> Find(key, &amp;iSlot);
00058     }
00059 
00060 <span class="keyword">private</span>:
00061     <span class="keyword">struct </span>Element {
00062         <a class="code" href="objects_8h.html#a5">Value</a>   key;
00063         VALUE_T value;
00064     };
00065 
00066     <span class="keywordtype">bool</span>    Find(Value key, <span class="keywordtype">int</span>* iSlot)
00067     {
00068         <span class="keywordtype">int</span> hash = ((UInt32) key * 0x9e3779b9) &amp; m_mask;
00069         <span class="keywordtype">int</span> incr = ((hash * 13) &amp; m_mask) | 1;
00070         <span class="keywordflow">for</span> (;;) {
00071             <a class="code" href="objects_8h.html#a5">Value</a> k = m_table[hash].key;
00072             <span class="keywordflow">if</span> (k == 0) {
00073                 *iSlot = hash;
00074                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00075             }
00076             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (V_EQ(k, key)) {
00077                 *iSlot = hash;
00078                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00079             }
00080 
00081             hash = (hash + incr) &amp; m_mask;
00082         }
00083 
00084         ASSERT(<span class="keyword">false</span>);
00085         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00086     }
00087 
00088     <span class="keywordtype">void</span>    SetCapacity(<span class="keywordtype">int</span> newCapacity)
00089     {
00090         m_capacity = newCapacity;
00091         m_mask = m_capacity - 1;
00092         m_table = (Element*) GC_MALLOC(m_capacity * <span class="keyword">sizeof</span>(Element));
00093         memset(m_table, 0, m_capacity * <span class="keyword">sizeof</span>(Element));
00094     }
00095 
00096     <span class="keywordtype">void</span>    Resize(<span class="keywordtype">int</span> newCapacity)
00097     {
00098         <span class="keywordtype">int</span> oldCapacity = m_capacity;
00099         Element* oldTable = m_table;
00100         
00101         SetCapacity(32);
00102 
00103         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; oldCapacity; i++)
00104             Set(oldTable[i].key, oldTable[i].value);
00105     }
00106 
00107     <span class="keywordtype">int</span>     m_size;
00108     <span class="keywordtype">int</span>     m_capacity;
00109     <span class="keywordtype">int</span>     m_mask;
00110     Element* m_table;
00111 };
00112 
00113 <span class="preprocessor">#endif // __OBJHASH_H__</span>
</pre></div><hr><address style="align: right;"><small>Generated on Sun Feb 9 20:47:37 2003 for Prota by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
